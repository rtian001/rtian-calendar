<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>值班日历</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="rtianCalendar.css">
        <link rel="stylesheet" href="rtianDuty-0.css">
        <script src="rtianCalendar.js"></script>
        <script src="rtianDuty-0.js"></script>
        <script>
            var bashurl = 'http://222.21.113.253:3000';
            var cdate = formatDate(new Date());
            var rygh = '220002'
            window.onload = async () => {
                //初始化日历组件
                var duty_title = document.querySelector('.sectiontitle>span');
                const calender = new rtianCalender('#calendar')
                calender.render({
                    showPublicHoliday: true,
                    theme: "block",
                    // date: '2025-12-01',
                    width: 280,
                    height: 320
                });
                await init(cdate)

                async function init(date) {
                    await renderMyDuty(date);//在日历上显示个人值班日
                    await renderDuty(date);//生成当日值班
                }
                //重定义日历事件：切换月份时，获取当前月份的节假日，并渲染到日历
                calender.change = async function (date) {
                    init(date)
                }
                //重定义日历事件：切换到指定日期
                calender.done = async function (date) {
                    await renderDuty(date);
                }

                //自定义事件：点击日期，渲染当日值班表
                async function renderDuty(dt) {
                    let d = new Date(dt);
                    let day = d.getDay();
                    let days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    let dtstr = `${dt}(${days[day]})`;
                    duty_title.innerHTML = dtstr;
                    const data = await getDayDuty(dt);
                    if (data) {
                        if (!rtianDuty.doms) {
                            rtianDuty.render({
                                elem: '#duty-content',
                                data: data,
                                fixname: true //姓名对齐：两字和三字对齐
                            })
                            fixLetterSpace();//修复 处级干部和带班校领导 对齐
                        } else {
                            rtianDuty.reload({
                                data: data
                            })
                        }

                    } else {
                        duty_title.innerHTML = dtstr + '无值班';
                    }
                }

                async function renderMyDuty(date) {//在日历上显示个人值班日
                    let month = date.slice(0, 7);
                    let duty_data = await getMyDuty(rygh, month);
                    calender.renderMaker(duty_data);
                }

                async function getDayDuty(date) {//获取单日值班表
                    return new Promise((resolve, reject) => {
                        fetch(`${bashurl}/getduty?date=${date}`).then(resp => {
                            resolve(resp.json());
                        }).catch(err => {
                            reject('无法从服务器获取数据。');
                        })
                    })
                }
                async function getMyDuty(rygh, month) {
                    //获取个人值班日 
                    // //根据工号获取当月个人值班日期；数组
                    return new Promise(async (resolve, reject) => {
                        fetch(`${bashurl}/getmydutydate?rygh=${rygh}&month=${month}`).then(resp => {
                            resolve(resp.json());
                        }).catch(err => {
                            reject('无法从服务器获取数据。');
                        })
                    })
                }
                function fixLetterSpace() {//修复文字对齐：4字和5字对齐
                    let dom = document.querySelector('.item-0 .level-1.item-1 .key-level-1')
                    let value = dom.innerText;
                    dom.innerHTML = `<span class="letter1">${value.slice(0, -1)}</span><span>${value.slice(-1)}</span>`
                }

            }
            function formatDate(date) {
                let y, m, d;
                if (typeof date == 'string') {
                    [y, m, d] = date.split(/-|\//g);
                } else {
                    y = date.getFullYear();
                    m = date.getMonth() + 1;
                    d = date.getDate();
                }
                return `${y}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`
            }

        </script>
    </head>

    <body>
        <main>
            <aside>
                <div class="calendar-title">值班日历</div>
                <div class="aside">
                    <div id="calendar"></div>
                </div>
            </aside>
            <article>
                <div class="sectiontitle">值班日期：<span>2026-06-13(周五)</span><span class="calendarico"><img
                            src="calendar.svg" alt="" srcset=""></span></div>
                <div id="duty-content" class="sectioncontent"></div>
            </article>
        </main>
    </body>

</html>